

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  
    <title>DB structure - Insights Results Aggregator</title>

    
  

  <link rel="shortcut icon" href="/insights-results-aggregator/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="/insights-results-aggregator/assets/css/just-the-docs-default.css">

  

  
  <script type="text/javascript" src="/insights-results-aggregator/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>DB structure | Insights Results Aggregator</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="DB structure" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Aggregator service for Openshist insights results" />
<meta property="og:description" content="Aggregator service for Openshist insights results" />
<link rel="canonical" href="https://redhatinsights.github.io/insights-results-aggregator/db_structure.html" />
<meta property="og:url" content="https://redhatinsights.github.io/insights-results-aggregator/db_structure.html" />
<meta property="og:site_name" content="Insights Results Aggregator" />
<script type="application/ld+json">
{"description":"Aggregator service for Openshist insights results","url":"https://redhatinsights.github.io/insights-results-aggregator/db_structure.html","@type":"WebPage","headline":"DB structure","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
      <title>Link</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
      </svg>
    </symbol>
    <symbol id="svg-search" viewBox="0 0 24 24">
      <title>Search</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
        <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </symbol>
    <symbol id="svg-menu" viewBox="0 0 24 24">
      <title>Menu</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
        <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </symbol>
    <symbol id="svg-arrow-right" viewBox="0 0 24 24">
      <title>Expand</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </symbol>
    <symbol id="svg-doc" viewBox="0 0 24 24">
      <title>Document</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
      </svg>
    </symbol>
  </svg>

  <div class="side-bar">
    <div class="site-header">
      <a href="https://redhatinsights.github.io/insights-results-aggregator/" class="site-title lh-tight">
  Insights Results Aggregator

</a>
      <a href="#" id="menu-button" class="site-button">
        <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
      </a>
    </div>
    <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      
        <ul class="nav-list"><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/architecture.html" class="nav-list-link">Architecture</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/configuration.html" class="nav-list-link">Configuration</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/database.html" class="nav-list-link">Database</a></li><li class="nav-list-item active"><a href="https://redhatinsights.github.io/insights-results-aggregator/db_structure.html" class="nav-list-link active">DB structure</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/rest_api.html" class="nav-list-link">REST API</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/authentication.html" class="nav-list-link">Authentication</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/prometheus.html" class="nav-list-link">Prometheus API</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/pprof.html" class="nav-list-link">pprof</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/rules.html" class="nav-list-link">Rules</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/testing.html" class="nav-list-link">Testing</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/ci.html" class="nav-list-link">CI</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/utilities.html" class="nav-list-link">Utilities</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/local_setup.html" class="nav-list-link">Local setup</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/documentation_for_developers.html" class="nav-list-link">Documentation for developers</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/references.html" class="nav-list-link">References</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/" class="nav-list-link">Description</a></li></ul>

      
    </nav>
    <footer class="site-footer">
      This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.
    </footer>
  </div>
  <div class="main" id="top">
    <div id="main-header" class="main-header">
      
      
      
        <nav aria-label="Auxiliary" class="aux-nav">
          <ul class="aux-nav-list">
            
              <li class="aux-nav-list-item">
                <a href="https://github.com/RedHatInsights/insights-results-aggregator" class="site-button"
                  
                >
                  Github repository
                </a>
              </li>
            
          </ul>
        </nav>
      
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
      
      <div id="main-content" class="main-content" role="main">
        
          <h1 class="no_toc" id="db-structure">
        
        
          <a href="#db-structure" class="anchor-heading" aria-labelledby="db-structure"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> DB structure
        
        
      </h1>
    
      <h2 class="no_toc text-delta" id="table-of-contents">
        
        
          <a href="#table-of-contents" class="anchor-heading" aria-labelledby="table-of-contents"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table of contents
        
        
      </h2>
    

<ol id="markdown-toc">
  <li><a href="#table-report" id="markdown-toc-table-report">Table report</a></li>
  <li><a href="#tables-rule-and-rule_error_key" id="markdown-toc-tables-rule-and-rule_error_key">Tables rule and rule_error_key</a></li>
  <li><a href="#table-cluster_rule_user_feedback" id="markdown-toc-table-cluster_rule_user_feedback">Table cluster_rule_user_feedback</a></li>
  <li><a href="#table-cluster_rule_toggle" id="markdown-toc-table-cluster_rule_toggle">Table cluster_rule_toggle</a></li>
  <li><a href="#table-consumer_error" id="markdown-toc-table-consumer_error">Table consumer_error</a></li>
</ol>
      <h2 id="table-report">
        
        
          <a href="#table-report" class="anchor-heading" aria-labelledby="table-report"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table report
        
        
      </h2>
    

<p>This table is used as a cache for reports consumed from broker. Size of this
table (i.e. number of records) scales linearly with the number of clusters,
because only latest report for given cluster is stored (it is guarantied by DB
constraints). That table has defined compound key <code class="language-plaintext highlighter-rouge">org_id+cluster</code>,
additionally <code class="language-plaintext highlighter-rouge">cluster</code> name needs to be unique across all organizations.
Additionally <code class="language-plaintext highlighter-rouge">kafka_offset</code> is used to speedup consuming messages from Kafka
topic in case the offset is lost due to issues in Kafka, Kafka library, or
the service itself (messages with lower offset are skipped):</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">report</span> <span class="p">(</span>
    <span class="n">org_id</span>          <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">cluster</span>         <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">UNIQUE</span><span class="p">,</span>
    <span class="n">report</span>          <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">reported_at</span>     <span class="nb">TIMESTAMP</span><span class="p">,</span>
    <span class="n">last_checked_at</span> <span class="nb">TIMESTAMP</span><span class="p">,</span>
    <span class="n">kafka_offset</span>    <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="mi">0</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">org_id</span><span class="p">,</span> <span class="k">cluster</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>
      <h2 id="tables-rule-and-rule_error_key">
        
        
          <a href="#tables-rule-and-rule_error_key" class="anchor-heading" aria-labelledby="tables-rule-and-rule_error_key"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Tables rule and rule_error_key
        
        
      </h2>
    

<p>These tables represent the content for Insights rules to be displayed by OCM.
The table <code class="language-plaintext highlighter-rouge">rule</code> represents more general information about the rule, whereas the <code class="language-plaintext highlighter-rouge">rule_error_key</code>
contains information about the specific type of error which occurred. The combination of these two
create an unique rule.
Very trivialized example could be:</p>

<ul>
  <li>rule “REQUIREMENTS_CHECK”
    <ul>
      <li>error_key “REQUIREMENTS_CHECK_LOW_MEMORY”</li>
      <li>error_key “REQUIREMENTS_CHECK_MISSING_SYSTEM_PACKAGE”</li>
    </ul>
  </li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">rule</span> <span class="p">(</span>
    <span class="n">module</span>      <span class="nb">VARCHAR</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">name</span>        <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">summary</span>     <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">reason</span>      <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">resolution</span>  <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">more_info</span>   <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">rule_error_key</span> <span class="p">(</span>
    <span class="n">error_key</span>       <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">rule_module</span>     <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">REFERENCES</span> <span class="k">rule</span><span class="p">(</span><span class="n">module</span><span class="p">),</span>
    <span class="n">condition</span>       <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">description</span>     <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">impact</span>          <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">likelihood</span>      <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">publish_date</span>    <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">active</span>          <span class="nb">BOOLEAN</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">generic</span>         <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">tags</span>            <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="s1">''</span><span class="p">,</span>
    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">error_key</span><span class="p">,</span> <span class="n">rule_module</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>
      <h2 id="table-cluster_rule_user_feedback">
        
        
          <a href="#table-cluster_rule_user_feedback" class="anchor-heading" aria-labelledby="table-cluster_rule_user_feedback"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table cluster_rule_user_feedback
        
        
      </h2>
    

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- user_vote is user's vote,</span>
<span class="c1">-- 0 is none,</span>
<span class="c1">-- 1 is like,</span>
<span class="c1">-- -1 is dislike</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">cluster_rule_user_feedback</span> <span class="p">(</span>
    <span class="n">cluster_id</span>  <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">rule_id</span>     <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">user_id</span>     <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">message</span>     <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">user_vote</span>   <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">added_at</span>    <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">updated_at</span>  <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>

    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span> <span class="n">rule_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">cluster_id</span><span class="p">)</span>
        <span class="k">REFERENCES</span> <span class="n">report</span><span class="p">(</span><span class="k">cluster</span><span class="p">)</span>
        <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span><span class="p">,</span>
    <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">rule_id</span><span class="p">)</span>
        <span class="k">REFERENCES</span> <span class="k">rule</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="p">)</span>
</code></pre></div></div>
      <h2 id="table-cluster_rule_toggle">
        
        
          <a href="#table-cluster_rule_toggle" class="anchor-heading" aria-labelledby="table-cluster_rule_toggle"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table cluster_rule_toggle
        
        
      </h2>
    

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">cluster_rule_toggle</span> <span class="p">(</span>
    <span class="n">cluster_id</span>  <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">rule_id</span>     <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">user_id</span>     <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">disabled</span>    <span class="nb">SMALLINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">disabled_at</span> <span class="nb">TIMESTAMP</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">enabled_at</span>  <span class="nb">TIMESTAMP</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">updated_at</span>  <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>

    <span class="k">CHECK</span> <span class="p">(</span><span class="n">disabled</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">AND</span> <span class="n">disabled</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">),</span>

    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span> <span class="n">rule_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>
      <h2 id="table-consumer_error">
        
        
          <a href="#table-consumer_error" class="anchor-heading" aria-labelledby="table-consumer_error"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Table consumer_error
        
        
      </h2>
    

<p>Errors that happen while processing a message consumed from Kafka are logged into this table. This
allows easier debugging of various issues, especially those related to unexpected input data format.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">consumer_error</span> <span class="p">(</span>
    <span class="n">topic</span>           <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">partition</span>       <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">topic_offset</span>    <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="k">key</span>             <span class="nb">VARCHAR</span><span class="p">,</span>
    <span class="n">produced_at</span>     <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">consumed_at</span>     <span class="nb">TIMESTAMP</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">message</span>         <span class="nb">VARCHAR</span><span class="p">,</span>
    <span class="n">error</span>           <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>

    <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="n">partition</span><span class="p">,</span> <span class="n">topic_offset</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

        

        

        
        
          <hr>
          <footer>
            

            <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2020 Red Hat, Inc.</a></p>

            
          </footer>
        

      </div>
    </div>

    
  </div>
</body>
</html>

