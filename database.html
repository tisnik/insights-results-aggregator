

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  
    <title>Database - Insights Results Aggregator</title>

    
  

  <link rel="shortcut icon" href="/insights-results-aggregator/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="/insights-results-aggregator/assets/css/just-the-docs-default.css">

  

  
  <script type="text/javascript" src="/insights-results-aggregator/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Database | Insights Results Aggregator</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Database" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Aggregator service for Openshist insights results" />
<meta property="og:description" content="Aggregator service for Openshist insights results" />
<link rel="canonical" href="https://redhatinsights.github.io/insights-results-aggregator/database.html" />
<meta property="og:url" content="https://redhatinsights.github.io/insights-results-aggregator/database.html" />
<meta property="og:site_name" content="Insights Results Aggregator" />
<script type="application/ld+json">
{"description":"Aggregator service for Openshist insights results","url":"https://redhatinsights.github.io/insights-results-aggregator/database.html","@type":"WebPage","headline":"Database","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  

</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
      <title>Link</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
      </svg>
    </symbol>
    <symbol id="svg-search" viewBox="0 0 24 24">
      <title>Search</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
        <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </symbol>
    <symbol id="svg-menu" viewBox="0 0 24 24">
      <title>Menu</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
        <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </symbol>
    <symbol id="svg-arrow-right" viewBox="0 0 24 24">
      <title>Expand</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </symbol>
    <symbol id="svg-doc" viewBox="0 0 24 24">
      <title>Document</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
      </svg>
    </symbol>
  </svg>

  <div class="side-bar">
    <div class="site-header">
      <a href="https://redhatinsights.github.io/insights-results-aggregator/" class="site-title lh-tight">
  Insights Results Aggregator

</a>
      <a href="#" id="menu-button" class="site-button">
        <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
      </a>
    </div>
    <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      
        <ul class="nav-list"><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/architecture.html" class="nav-list-link">Architecture</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/configuration.html" class="nav-list-link">Configuration</a></li><li class="nav-list-item active"><a href="https://redhatinsights.github.io/insights-results-aggregator/database.html" class="nav-list-link active">Database</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/db_structure.html" class="nav-list-link">DB structure</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/rest_api.html" class="nav-list-link">REST API</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/authentication.html" class="nav-list-link">Authentication</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/prometheus.html" class="nav-list-link">Prometheus API</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/pprof.html" class="nav-list-link">pprof</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/rules.html" class="nav-list-link">Rules</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/testing.html" class="nav-list-link">Testing</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/ci.html" class="nav-list-link">CI</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/utilities.html" class="nav-list-link">Utilities</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/local_setup.html" class="nav-list-link">Local setup</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/documentation_for_developers.html" class="nav-list-link">Documentation for developers</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/references.html" class="nav-list-link">References</a></li><li class="nav-list-item"><a href="https://redhatinsights.github.io/insights-results-aggregator/" class="nav-list-link">Description</a></li></ul>

      
    </nav>
    <footer class="site-footer">
      This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.
    </footer>
  </div>
  <div class="main" id="top">
    <div id="main-header" class="main-header">
      
      
      
        <nav aria-label="Auxiliary" class="aux-nav">
          <ul class="aux-nav-list">
            
              <li class="aux-nav-list-item">
                <a href="https://github.com/RedHatInsights/insights-results-aggregator" class="site-button"
                  
                >
                  Github repository
                </a>
              </li>
            
          </ul>
        </nav>
      
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
      
      <div id="main-content" class="main-content" role="main">
        
          <h1 id="database">
        
        
          <a href="#database" class="anchor-heading" aria-labelledby="database"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Database
        
        
      </h1>
    

<p>Aggregator is configured to use SQLite3 DB by default, but it also supports PostgreSQL.
In CI and QA environments, the configuration is overridden by environment variables to use
PostgreSQL.</p>

<p>To establish connection to the PostgreSQL instance provided by the minimal stack in
<code class="language-plaintext highlighter-rouge">docker-compose.yml</code> for local setup, the following configuration options need to be changed in
<code class="language-plaintext highlighter-rouge">storage</code> section of <code class="language-plaintext highlighter-rouge">config.toml</code>:</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[storage]</span>
<span class="py">db_driver</span> <span class="p">=</span> <span class="s">"postgres"</span>
<span class="py">pg_username</span> <span class="p">=</span> <span class="s">"user"</span>
<span class="py">pg_password</span> <span class="p">=</span> <span class="s">"password"</span>
<span class="py">pg_host</span> <span class="p">=</span> <span class="s">"localhost"</span>
<span class="py">pg_port</span> <span class="p">=</span> <span class="mi">55432</span>
<span class="py">pg_db_name</span> <span class="p">=</span> <span class="s">"aggregator"</span>
<span class="py">pg_params</span> <span class="p">=</span> <span class="s">"sslmode=disable"</span>
</code></pre></div></div>
      <h2 id="migration-mechanism">
        
        
          <a href="#migration-mechanism" class="anchor-heading" aria-labelledby="migration-mechanism"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Migration mechanism
        
        
      </h2>
    

<p>This service contains an implementation of a simple database migration mechanism that allows
semi-automatic transitions between various database versions as well as building the latest version
of the database from scratch.</p>

<p>The migrations are no longer performed during initialization of the service to make running multiple
instances of the service in parallel against the same database safer. Instead, the database
migration version can now be set using the built-in CLI sub-command <code class="language-plaintext highlighter-rouge">migration</code> (aliases:
<code class="language-plaintext highlighter-rouge">migrations</code> and <code class="language-plaintext highlighter-rouge">migrate</code>).</p>
      <h3 id="printing-information-about-database-migrations">
        
        
          <a href="#printing-information-about-database-migrations" class="anchor-heading" aria-labelledby="printing-information-about-database-migrations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Printing information about database migrations
        
        
      </h3>
    

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./insights-results-aggregator migrations
</code></pre></div></div>
      <h3 id="upgrading-the-database-to-the-latest-available-migration">
        
        
          <a href="#upgrading-the-database-to-the-latest-available-migration" class="anchor-heading" aria-labelledby="upgrading-the-database-to-the-latest-available-migration"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Upgrading the database to the latest available migration
        
        
      </h3>
    

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./insights-results-aggregator migration latest
</code></pre></div></div>
      <h3 id="downgrading-to-the-base-empty-database-migration-version">
        
        
          <a href="#downgrading-to-the-base-empty-database-migration-version" class="anchor-heading" aria-labelledby="downgrading-to-the-base-empty-database-migration-version"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Downgrading to the base (empty) database migration version
        
        
      </h3>
    

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./insights-results-aggregator migration 0
</code></pre></div></div>

<p>Before using the migration mechanism, it is first necessary to initialize the migration information
table <code class="language-plaintext highlighter-rouge">migration_info</code>. This can be done using the <code class="language-plaintext highlighter-rouge">migration.InitInfoTable(*sql.DB)</code> function. Any
attempt to get or set the database version without initializing this table first will result in a
<code class="language-plaintext highlighter-rouge">no such table: migration_info</code> error from the SQL driver.</p>

<p>New migrations must be added manually into the code, because it was decided that modifying the list
of migrations at runtime is undesirable.</p>

<p>To migrate the database to a certain version, in either direction (both upgrade and downgrade), use
the <code class="language-plaintext highlighter-rouge">migration.SetDBVersion(*sql.DB, migration.Version)</code> function.</p>

<p><strong>To upgrade the database to the highest available version, use
<code class="language-plaintext highlighter-rouge">migration.SetDBVersion(db, migration.GetMaxVersion())</code>.</strong> This will automatically perform all the
necessary steps to migrate the database from its current version to the highest defined version.</p>

<p>See <code class="language-plaintext highlighter-rouge">/migration/migration.go</code> documentation for an overview of all available DB migration
functionality.</p>

        

        

        
        
          <hr>
          <footer>
            

            <p class="text-small text-grey-dk-100 mb-0">Copyright &copy; 2020 Red Hat, Inc.</a></p>

            
          </footer>
        

      </div>
    </div>

    
  </div>
</body>
</html>

